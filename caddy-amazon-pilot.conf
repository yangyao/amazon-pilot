# Amazon Pilot Caddy配置文件
# 使用方法：在主Caddyfile中添加 import /path/to/caddy-amazon-pilot.conf

# ===========================================
# Amazon Pilot 主应用
# ===========================================
amazon-pilot.phpman.top {
    # API路由（优先匹配）
    handle /api/* {
        reverse_proxy localhost:8080 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-Proto {scheme}
            health_uri /health
            health_interval 30s
            health_timeout 5s
        }
    }

    # 前端应用（默认路由）
    handle {
        reverse_proxy localhost:4000 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-Proto {scheme}
            health_uri /
            health_interval 30s
            health_timeout 5s
        }
    }

    # 安全头配置
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
        -X-Powered-By
    }

    # 访问日志
    log {
        output file /var/log/caddy/amazon-pilot-access.log {
            roll_size 100mb
            roll_keep 10
            roll_keep_for 2160h  # 90天
        }
        format json {
            time_format "2006-01-02T15:04:05.000Z07:00"
        }
    }

    # 错误处理
    handle_errors {
        @5xx expression `{err.status_code} >= 500`
        @4xx expression `{err.status_code} >= 400 && {err.status_code} < 500`

        handle @5xx {
            respond `
            <!DOCTYPE html>
            <html><head><title>Service Unavailable</title></head>
            <body style="font-family: Arial, sans-serif; text-align: center; padding: 50px;">
            <h1>Amazon Pilot - Service Temporarily Unavailable</h1>
            <p>We're experiencing technical difficulties. Please try again later.</p>
            <p>Error: {err.status_code}</p>
            <a href="/" style="color: #0066cc;">Return to Home</a>
            </body></html>
            ` 503
        }

        handle @4xx {
            respond `
            <!DOCTYPE html>
            <html><head><title>Page Not Found</title></head>
            <body style="font-family: Arial, sans-serif; text-align: center; padding: 50px;">
            <h1>Amazon Pilot - Page Not Found</h1>
            <p>The requested page could not be found.</p>
            <a href="/" style="color: #0066cc;">Return to Home</a>
            </body></html>
            ` {err.status_code}
        }
    }
}

# ===========================================
# API直接访问（调试专用）
# ===========================================
api.amazon-pilot.phpman.top {
    reverse_proxy localhost:8080 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-Proto {scheme}
        health_uri /health
        health_interval 30s
        health_timeout 5s
    }

    # 基本认证保护API直接访问
    basicauth {
        admin $2a$14$8k.4K5dMFQI5oZ.8yZBvr.AZz.7Lm2U4F8D9vY7KjH4P9oM1N2Q8S  # admin123
    }

    # 访问日志
    log {
        output file /var/log/caddy/amazon-pilot-api.log {
            roll_size 50mb
            roll_keep 5
            roll_keep_for 720h
        }
        format json
    }
}

# ===========================================
# 管理监控界面
# ===========================================
monitor.amazon-pilot.phpman.top {
    reverse_proxy localhost:5555 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }

    # 基本认证保护（生产环境必须）
    basicauth {
        admin $2a$14$8k.4K5dMFQI5oZ.8yZBvr.AZz.7Lm2U4F8D9vY7KjH4P9oM1N2Q8S  # admin123
    }

    # 访问日志
    log {
        output file /var/log/caddy/amazon-pilot-monitor.log {
            roll_size 50mb
            roll_keep 5
            roll_keep_for 720h
        }
        format json
    }
}

# Grafana监控界面
grafana.amazon-pilot.phpman.top {
    reverse_proxy localhost:3001 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }

    # 基本认证保护（生产环境必须）
    basicauth {
        admin $2a$14$8k.4K5dMFQI5oZ.8yZBvr.AZz.7Lm2U4F8D9vY7KjH4P9oM1N2Q8S  # admin123
    }

    # 访问日志
    log {
        output file /var/log/caddy/amazon-pilot-grafana.log {
            roll_size 50mb
            roll_keep 5
            roll_keep_for 720h
        }
        format json
    }
}