# 系統架構設計文件

## 概述

本文件描述 Amazon 賣家產品監控與優化工具的整體系統架構設計，包含後端服務架構、部署拓撲、資料流向和擴展策略。

**實現的核心功能**：
- 產品資料追蹤系統 - 完整實現
- 競品分析引擎 - 完整實現，包含LLM報告生成

## 系統架構概覽

### 設計原則

1. **微服務架構**: 模組化設計，職責明確分離
2. **水平擴展**: 支持服務和資料庫的水平擴展
3. **高可用性**: 消除單點故障，實現故障自動恢復
4. **可觀測性**: 完整的日誌、監控和追踪系統
5. **安全優先**: 多層次安全防護機制

### 核心技術棧

- **後端框架**: Go + go-zero微服務架構
- **ORM**: GORM v2 + 自定義JSON結構化日誌
- **資料庫**: PostgreSQL + Redis (快取層)
- **消息佇列**: Redis + Asynq (異步任務處理)
- **LLM集成**: DeepSeek API (競爭定位報告生成)
- **數據源**: Apify API (Amazon產品數據爬取)
- **前端**: Next.js + React + TypeScript + Tailwind CSS
- **API網關**: 統一路由和認證
- **監控**: Prometheus + Grafana + 結構化JSON日誌
- **部署**: Docker + Docker Compose + GitHub Actions CI/CD

## 微服務架構設計

### 1. API Gateway

**職責**:
- 請求路由和負載均衡
- 統一認證和授權
- Rate limiting 和 API 版本控制
- 請求/回應日誌記錄

### 2. Authentication Service

**職責**:
- 用戶註冊和登入
- JWT token 生成和驗證
- 權限管理
- 用戶資料管理

### 3. Product Tracking Service

**職責**:
- Amazon產品數據抓取和更新 (Apify集成)
- 用戶追蹤設定管理 (固定每日更新)
- 歷史數據存儲 (價格、BSR、評分、評論數歷史)
- 異常變化檢測和警報 (價格變動>10%, BSR變動>30%)
- 產品數據快取管理 (Redis 1小時TTL)

**核心特性**:
- 基於Apify爬蟲的真實Amazon數據
- 異步任務處理 (Worker + Scheduler)
- 多維度異常檢測算法
- 結構化JSON日誌記錄
- 完整的產品特徵數據 (bullet points, images)

### 4. Competitor Analysis Service

**職責**:
- 競品分析組管理（主產品 + 3-5個競品）
- 多維度比較分析（價格、BSR、評分、產品特色）
- LLM驅動的競爭定位報告生成
- 固定每日自動分析調度

**核心特性**:
- 從已追蹤產品選擇主產品和競品 (復用現有數據)
- 利用現有Apify爬蟲數據，避免重複開發
- 固定每日更新頻率（不可用戶配置）
- 使用事務確保分析組和競品關聯的數據一致性
- DeepSeek LLM驅動的競爭定位報告生成

**多維度分析實現**:
- 價格差異分析 - 基於product_price_history真實數據
- BSR排名差距 - 基於product_ranking_history數據
- 評分優劣勢 - 基於評分和評論數歷史
- 產品特色對比 - 基於bullet_points特徵數據
- LLM競爭洞察 - DeepSeek生成的市場定位建議

### 5. Optimization Service

**職責**:
- Listing 優化分析
- OpenAI API 整合
- 優化建議生成
- A/B 測試追蹤

### 6. Notification Service

**職責**:
- 實時通知管理
- 多渠道通知發送 (Email, Push, Webhook)
- 通知模板管理
- 通知歷史記錄

## 資料流向設計

### 1. 產品追蹤資料流

1. 用戶通過前端發起產品追蹤請求
2. API Gateway 驗證請求並轉發至 Product Service
3. Product Service 將任務加入 Asynq 佇列
4. Worker 從佇列取出任務，調用 Apify API 抓取數據
5. 數據存儲至 PostgreSQL，同時更新 Redis 快取
6. 異常檢測模組分析數據變化
7. 觸發條件時通過 Notification Service 發送通知

### 2. 競品分析資料流

1. 用戶選擇主產品和競品創建分析組
2. Competitor Service 驗證產品並建立關聯
3. Scheduler 定時觸發分析任務
4. 系統並行抓取所有產品數據
5. 數據標準化處理後進行多維度比較
6. 調用 DeepSeek API 生成競爭洞察報告
7. 分析結果存儲並推送通知

## 快取與佇列設計

### Redis 快取架構

**快取層級**:
- L1 Cache: 熱門產品基本資料 (TTL: 24小時)
- L2 Cache: 產品歷史資料 (TTL: 1小時)
- L3 Cache: 用戶相關資料 (TTL: 30分鐘)
- Session Cache: 用戶會話 (TTL: 7天)
- Rate Limiting: API 限流 (TTL: 1分鐘)

### 任務佇列設計

**佇列類型**:
- 高優先級佇列: 即時數據刷新、用戶請求
- 普通佇列: 定時更新、批量處理
- 低優先級佇列: 報告生成、數據清理

**任務調度**:
- Cron 排程: 每日固定時間更新
- 即時觸發: 用戶手動刷新
- 重試機制: 失敗任務自動重試3次

## 部署架構

### 容器化部署

**服務拆分**:
- 每個微服務獨立容器化
- 使用 Alpine Linux 最小化鏡像體積
- 多階段構建優化編譯過程

**編排管理**:
- Docker Compose 本地開發環境
- 生產環境分離配置 (docker-compose.prod.yml)
- 環境變量管理敏感配置

### 水平擴展策略

**負載均衡**:
- Caddy 反向代理分發請求
- 最少連接數算法
- 健康檢查自動剔除故障節點

**自動擴展**:
- 基於 CPU/記憶體使用率
- 佇列長度觸發 Worker 擴展
- 數據庫連接池動態調整

## 監控與維運設計

### 監控指標

**系統指標**:
- CPU 使用率
- 記憶體使用率
- 磁碟 I/O
- 網路流量

**應用指標**:
- API 回應時間
- 錯誤率
- 請求吞吐量
- 佇列長度

**業務指標**:
- 產品追蹤數量
- 分析完成率
- 用戶活躍度
- API 使用量

### 日誌架構

**結構化日誌**:
- JSON 格式統一輸出
- 分級日誌 (DEBUG, INFO, WARN, ERROR)
- 集中式日誌收集 (Loki)
- 關鍵業務操作審計日誌

### 錯誤追蹤與告警

**告警規則**:
- 高錯誤率告警 (>10% 5xx 錯誤)
- 高響應時間告警 (P95 > 1秒)
- 佇列積壓告警 (>1000 待處理任務)
- 數據庫連接池耗盡告警

## 安全性架構

### API 安全

**認證與授權**:
- JWT Token 認證
- RBAC 角色權限控制
- API Key 管理
- Rate Limiting 防護

### 資料安全

**敏感資料保護**:
- 密碼 bcrypt 加密
- API Token 環境變量管理
- 數據庫連接 SSL/TLS
- 敏感日誌脫敏

### 網路安全

**安全防護**:
- HTTPS 強制加密傳輸
- CORS 跨域策略
- 安全標頭配置
- DDoS 防護

## 效能優化策略

### 資料庫優化

**連接池設定**:
- 最大連接數: 100
- 最大空閒連接: 10
- 連接最大生命週期: 1小時

**查詢優化**:
- 索引優化 (ASIN, user_id, created_at)
- 批量操作減少往返
- 預加載關聯數據
- 分頁查詢限制

### 快取優化

**多層快取策略**:
- CDN 靜態資源快取
- Redis 應用層快取
- PostgreSQL 查詢快取
- 本地記憶體快取

## 災難恢復計畫

### 備份策略

**數據備份**:
- 每日全量備份
- 每小時增量備份
- 異地備份存儲
- 30天備份保留

### 故障恢復

**高可用保障**:
- 服務健康檢查
- 自動故障轉移
- 數據主從複製
- 快速回滾機制

## 擴展性規劃

### 水平擴展

**微服務擴展**:
- 各服務獨立擴展
- 無狀態設計
- 負載均衡分發

**數據庫擴展**:
- 讀寫分離
- 分片策略
- 連接池優化

### 垂直擴展

**資源優化**:
- CPU 密集型: 增加核心數
- I/O 密集型: SSD 存儲
- 記憶體密集型: 擴大 RAM