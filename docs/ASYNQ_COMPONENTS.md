# Asynq 组件说明

## 概述

Amazon Pilot 使用 Asynq 作为后台任务处理系统，包含三个核心组件：

## 1. Worker (任务执行器)

**职责**：
- 执行后台任务
- 处理队列中的任务
- 调用外部 API (Apify, OpenAI)
- 更新数据库

**主要任务类型**：
- `update_product`: 产品数据更新
- `batch_update_products`: 批量产品更新
- `competitor_analysis`: 竞品分析
- `optimization_analysis`: 优化分析
- `send_notification`: 发送通知

**配置**：
- 并发数：10
- 队列优先级：critical(6) > default(3) > low(1)
- 自动重试机制

## 2. Scheduler (任务调度器)

**职责**：
- 定时任务调度
- Cron 表达式支持
- 自动创建周期性任务

**定时任务**：
- `@daily 09:00`: 每日产品更新
- `@hourly`: 每小时高频更新
- `0 */6 * * *`: 每6小时更新
- `0 2 * * 0`: 每周竞品分析
- `0 3 * * *`: 每日数据清理
- `0 1 * * 0`: 每周优化分析

## 3. Monitor (监控界面)

**职责**：
- Web UI 管理界面
- 实时监控队列状态
- 任务管理和调试
- 性能统计

**功能**：
- 查看队列长度和状态
- 监控任务执行情况
- 重试失败的任务
- 删除或暂停任务
- 查看任务详情和日志

## 架构关系

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Scheduler     │    │     Worker      │    │    Monitor      │
│  (任务调度器)    │    │   (任务执行器)   │    │   (监控界面)     │
└─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘
          │                      │                      │
          │                      │                      │
          ▼                      ▼                      ▼
    ┌─────────────────────────────────────────────────────────┐
    │                  Redis Queue                           │
    │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐      │
    │  │  critical   │ │   default   │ │     low     │      │
    │  │   queue     │ │   queue     │ │   queue     │      │
    │  └─────────────┘ └─────────────┘ └─────────────┘      │
    └─────────────────────────────────────────────────────────┘
```

## 部署说明

### 1. 必需性
- **Worker**: ✅ 必需 - 没有它任务无法执行
- **Scheduler**: ✅ 必需 - 没有它定时任务不会触发
- **Monitor**: ✅ 必需 - 用于监控和调试任务

### 2. 访问地址
- **Monitor UI**: https://monitor.amazon-pilot.phpman.top
- **Grafana**: https://grafana.amazon-pilot.phpman.top

### 3. 监控区别

| 组件 | 监控内容 | 用途 |
|------|----------|------|
| **Asynq Monitor** | 任务队列、任务状态、执行统计 | 开发调试、任务管理 |
| **Grafana** | 系统性能、API指标、业务指标 | 系统监控、性能分析 |

## 使用场景

### 开发阶段
- 使用 Monitor 查看任务执行情况
- 调试失败的任务
- 手动重试任务

### 生产环境
- 使用 Grafana 监控系统整体健康
- 使用 Monitor 处理异常任务
- 通过 Scheduler 确保定时任务正常运行

## 总结

这三个组件是 Asynq 任务系统的完整实现：
- **Worker** 负责执行
- **Scheduler** 负责调度
- **Monitor** 负责监控

缺一不可，共同构成了完整的后台任务处理系统。
