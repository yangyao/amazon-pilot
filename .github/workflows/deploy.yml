name: Amazon Pilot - Production Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy (all/auth/product/competitor/optimization/frontend/worker/scheduler/dashboard/gateway)'
        required: false
        default: 'all'

env:
  DEPLOY_DIR: /opt/amazon-pilot
  COMPOSE_FILE: deployments/compose/docker-compose.yml
  ENV_FILE: deployments/compose/.env.production

jobs:
  # å¹¶å‘æž„å»ºæ‰€æœ‰æœåŠ¡
  build-auth:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Build Auth Service
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          docker build -f docker/Dockerfile.auth -t amazon-pilot-auth:latest .
          docker save amazon-pilot-auth:latest | gzip > auth-image.tar.gz
      - uses: actions/upload-artifact@v4
        with:
          name: auth-image
          path: auth-image.tar.gz

  build-product:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Build Product Service
        run: |
          docker build -f docker/Dockerfile.product -t amazon-pilot-product:latest .
          docker save amazon-pilot-product:latest | gzip > product-image.tar.gz
      - uses: actions/upload-artifact@v4
        with:
          name: product-image
          path: product-image.tar.gz

  build-competitor:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Build Competitor Service
        run: |
          docker build -f docker/Dockerfile.competitor -t amazon-pilot-competitor:latest .
          docker save amazon-pilot-competitor:latest | gzip > competitor-image.tar.gz
      - uses: actions/upload-artifact@v4
        with:
          name: competitor-image
          path: competitor-image.tar.gz

  build-optimization:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Build Optimization Service
        run: |
          docker build -f docker/Dockerfile.optimization -t amazon-pilot-optimization:latest .
          docker save amazon-pilot-optimization:latest | gzip > optimization-image.tar.gz
      - uses: actions/upload-artifact@v4
        with:
          name: optimization-image
          path: optimization-image.tar.gz

  build-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Build Frontend Service
        run: |
          docker build -f docker/Dockerfile.frontend -t amazon-pilot-frontend:latest .
          docker save amazon-pilot-frontend:latest | gzip > frontend-image.tar.gz
      - uses: actions/upload-artifact@v4
        with:
          name: frontend-image
          path: frontend-image.tar.gz

  build-gateway:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Build Gateway Service
        run: |
          docker build -f docker/Dockerfile.gateway -t amazon-pilot-gateway:latest .
          docker save amazon-pilot-gateway:latest | gzip > gateway-image.tar.gz
      - uses: actions/upload-artifact@v4
        with:
          name: gateway-image
          path: gateway-image.tar.gz

  build-worker:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Build Worker Service
        run: |
          docker build -f docker/Dockerfile.worker -t amazon-pilot-worker:latest .
          docker save amazon-pilot-worker:latest | gzip > worker-image.tar.gz
      - uses: actions/upload-artifact@v4
        with:
          name: worker-image
          path: worker-image.tar.gz

  build-scheduler:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Build Scheduler Service
        run: |
          docker build -f docker/Dockerfile.scheduler -t amazon-pilot-scheduler:latest .
          docker save amazon-pilot-scheduler:latest | gzip > scheduler-image.tar.gz
      - uses: actions/upload-artifact@v4
        with:
          name: scheduler-image
          path: scheduler-image.tar.gz

  build-dashboard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Build Dashboard Service
        run: |
          docker build -f docker/Dockerfile.dashboard -t amazon-pilot-dashboard:latest .
          docker save amazon-pilot-dashboard:latest | gzip > dashboard-image.tar.gz
      - uses: actions/upload-artifact@v4
        with:
          name: dashboard-image
          path: dashboard-image.tar.gz

  deploy:
    needs: [build-auth, build-product, build-competitor, build-optimization, build-frontend, build-gateway, build-worker, build-scheduler, build-dashboard]
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Upload Docker images to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "."
          target: "/tmp/amazon-pilot-deploy/"
          strip_components: 0

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          timeout: 600s
          envs: DATABASE_DSN,JWT_SECRET,APIFY_API_TOKEN,OPENAI_API_KEY,GRAFANA_PASSWORD
        env:
          DATABASE_DSN: ${{ secrets.DATABASE_DSN }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          APIFY_API_TOKEN: ${{ secrets.APIFY_API_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GRAFANA_PASSWORD: ${{ secrets.GRAFANA_PASSWORD }}
          script: |
            # ç®€åŒ–è„šæœ¬æµ‹è¯•SSHæ‰§è¡Œ
            echo "TEST: GitHub CI SSH script is executing"
            date > /tmp/github-ci-test.log
            echo "Current directory: $(pwd)" >> /tmp/github-ci-test.log
            echo "Environment variables:" >> /tmp/github-ci-test.log
            env | grep -E "(DATABASE_DSN|JWT_SECRET)" >> /tmp/github-ci-test.log

            # è¿›å…¥éƒ¨ç½²ç›®å½•
            cd ${{ env.DEPLOY_DIR }}
            echo "Changed to: $(pwd)" >> /tmp/github-ci-test.log
            
            # ç”Ÿæˆç”Ÿäº§çŽ¯å¢ƒé…ç½®
            echo "ðŸ“ Generating production environment file..."
            cat > ${{ env.ENV_FILE }} << EOF
            # Amazon Pilot ç”Ÿäº§çŽ¯å¢ƒé…ç½® - è‡ªåŠ¨ç”Ÿæˆ
            # ç”Ÿæˆæ—¶é—´: $(date)
            
            # æ•°æ®åº“é…ç½® (æ”¯æŒSupabaseç­‰å¤–éƒ¨æ•°æ®åº“)
            DATABASE_DSN=${DATABASE_DSN}
            DATABASE_MAX_IDLE_CONNS=10
            DATABASE_MAX_OPEN_CONNS=100
            DATABASE_CONN_MAX_LIFETIME=3600
            
            # Redisé…ç½® (æ— å¯†ç )
            REDIS_HOST=amazon-pilot-redis
            REDIS_PORT=6379
            REDIS_DB=0
            
            # API Keys
            APIFY_API_TOKEN=${APIFY_API_TOKEN}
            OPENAI_API_KEY=${OPENAI_API_KEY}
            
            # JWTé…ç½®
            JWT_SECRET=${JWT_SECRET}
            JWT_ACCESS_SECRET=${JWT_SECRET}
            JWT_ACCESS_EXPIRE=86400
            
            # Workeré…ç½®
            WORKER_CONCURRENCY=10
            WORKER_LOG_LEVEL=info

            # Scheduleré…ç½®
            SCHEDULER_PRODUCT_UPDATE_INTERVAL=5m
            
            # ç›‘æŽ§é…ç½®
            GRAFANA_PASSWORD=${GRAFANA_PASSWORD}
            
            # åº”ç”¨é…ç½®
            APP_ENV=production
            LOG_LEVEL=info
            ENVIRONMENT=production
            EOF
            
            # è®¾ç½®æ–‡ä»¶æƒé™
            chmod 600 ${{ env.ENV_FILE }}
            
            # è°ƒè¯•ä¿¡æ¯
            echo "ðŸ” Current directory: $(pwd)"
            echo "ðŸ“‹ Available files: $(ls -la)"
            echo "ðŸ³ Docker version: $(docker --version)"
            
            # å¤‡ä»½å½“å‰çŽ¯å¢ƒï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
            if [ -f "${{ env.COMPOSE_FILE }}" ]; then
              cp ${{ env.COMPOSE_FILE }} docker-compose.yml.backup.$(date +%Y%m%d_%H%M%S)
            fi
            
            echo "ðŸ“¦ Loading Docker images..."
            # æ£€æŸ¥ä¸Šä¼ çš„é•œåƒæ–‡ä»¶
            echo "ðŸ” æ£€æŸ¥ä¸Šä¼ çš„é•œåƒæ–‡ä»¶:"
            find /tmp/amazon-pilot-deploy -name "*.tar.gz" | head -10

            # åŠ è½½æ‰€æœ‰é•œåƒæ–‡ä»¶
            IMAGE_COUNT=0
            for image_file in $(find /tmp/amazon-pilot-deploy -name "*.tar.gz"); do
              if [ -f "$image_file" ]; then
                echo "ðŸ“¦ Loading $image_file..."
                if gunzip -c "$image_file" | docker load; then
                  echo "âœ… Successfully loaded $image_file"
                  IMAGE_COUNT=$((IMAGE_COUNT + 1))
                else
                  echo "âŒ Failed to load $image_file"
                fi
              fi
            done

            echo "ðŸ“Š Total images loaded: $IMAGE_COUNT"

            # éªŒè¯é•œåƒåŠ è½½æˆåŠŸ
            if [ "$IMAGE_COUNT" -lt 9 ]; then
              echo "âŒ Expected 9 images, only loaded $IMAGE_COUNT"
              exit 1
            fi

            echo "ðŸ” éªŒè¯åŠ è½½çš„é•œåƒ:"
            docker images amazon-pilot-auth | head -2
            docker images amazon-pilot-frontend | head -2
            
            echo "ðŸ”„ Performing rolling update..."
            echo "ðŸ“„ Using compose file: ${{ env.COMPOSE_FILE }}"
            echo "ðŸ“„ Using env file: ${{ env.ENV_FILE }}"

            # éªŒè¯æ–‡ä»¶å­˜åœ¨
            if [ ! -f "${{ env.COMPOSE_FILE }}" ]; then
              echo "âŒ Compose file not found: ${{ env.COMPOSE_FILE }}"
              exit 1
            fi

            if [ ! -f "${{ env.ENV_FILE }}" ]; then
              echo "âŒ Env file not found: ${{ env.ENV_FILE }}"
              exit 1
            fi

            # åœæ­¢çŽ°æœ‰æœåŠ¡
            echo "ðŸ›‘ Stopping existing services..."
            docker-compose -f ${{ env.COMPOSE_FILE }} down || echo "No existing services to stop"

            # å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆå¼ºåˆ¶é‡æ–°åˆ›å»ºï¼‰
            echo "ðŸš€ Starting all services with new images..."
            if docker-compose -f ${{ env.COMPOSE_FILE }} --env-file ${{ env.ENV_FILE }} up -d --force-recreate --remove-orphans; then
              echo "âœ… Services started successfully"
            else
              echo "âŒ Failed to start services"
              docker-compose -f ${{ env.COMPOSE_FILE }} logs --tail=20
              exit 1
            fi

            echo "ðŸ“Š Verifying services are running:"
            docker-compose -f ${{ env.COMPOSE_FILE }} ps
            
            echo "â³ Waiting for services to be ready..."
            sleep 60
            
            echo "ðŸ¥ Health check..."
            # å¥åº·æ£€æŸ¥
            curl -f http://localhost:8080/health || {
              echo "âŒ Health check failed!"
              docker-compose -f ${{ env.COMPOSE_FILE }} logs --tail=20
              exit 1
            }
            
            echo "ðŸ§¹ Cleanup..."
            # æ¸…ç†ä¸Šä¼ çš„é•œåƒæ–‡ä»¶
            echo "ðŸ—‘ï¸  æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
            rm -rf /tmp/amazon-pilot-deploy
            echo "ðŸ³ æ¸…ç†æ— ç”¨çš„Dockerèµ„æº..."
            docker system prune -f
            
            echo "âœ… Deployment completed successfully!"
            echo "ðŸŒ Service available at: https://amazon-pilot.phpman.top"
            echo "ðŸ“‹ Complete deployment log saved to: $LOGFILE"
            echo "ðŸ” To view full log: cat $LOGFILE"

            # ä¿å­˜æ—¥å¿—æ–‡ä»¶åˆ°æ°¸ä¹…ä½ç½®
            cp "$LOGFILE" /opt/amazon-pilot/logs/github-ci-$(date +%Y%m%d_%H%M%S).log

            echo "=========================================="
            echo "ðŸ• End time: $(date)"
            echo "âœ… GitHub CI Deployment Complete"
            echo "=========================================="

  notify:
    needs: [deploy]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Notify deployment status
        run: |
          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "âœ… Amazon Pilot deployment successful!"
            echo "ðŸŒ Available at: https://amazon-pilot.phpman.top"
          else
            echo "âŒ Amazon Pilot deployment failed!"
            echo "ðŸ” Check logs for details"
          fi